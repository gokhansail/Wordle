using System;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Windows.Forms;

public partial class CustomForm : Form
{
    private Timer fadeTimer = new Timer();
    private bool isClosing = false;
    private ToolStrip toolStrip = new ToolStrip();
    private ToolStripButton closeButton = new ToolStripButton();
    private ToolStripButton minimizeButton = new ToolStripButton();

    public CustomForm()
    {
        InitializeComponent();
        FormBorderStyle = FormBorderStyle.None;
        Opacity = 0;

        toolStrip.Dock = DockStyle.Top;
        toolStrip.AutoSize = false;
        toolStrip.Height = 30;
        toolStrip.BackColor = Color.LightGray;
        toolStrip.RenderMode = ToolStripRenderMode.Professional;
        toolStrip.GripStyle = ToolStripGripStyle.Hidden;
        toolStrip.LayoutStyle = ToolStripLayoutStyle.Flow;
        Controls.Add(toolStrip);

        closeButton.Image = SystemIcons.Error.ToBitmap();
        closeButton.DisplayStyle = ToolStripItemDisplayStyle.Image;
        closeButton.Click += (sender, e) => Close();
        toolStrip.Items.Add(closeButton);

        minimizeButton.Image = SystemIcons.Application.ToBitmap();
        minimizeButton.DisplayStyle = ToolStripItemDisplayStyle.Image;
        minimizeButton.Click += (sender, e) => WindowState = FormWindowState.Minimized;
        toolStrip.Items.Add(minimizeButton);

        ToolStripLabel spacer = new ToolStripLabel();
        spacer.Spring = true;
        toolStrip.Items.Add(spacer);

        fadeTimer.Interval = 10;
        fadeTimer.Tick += FadeIn;
        fadeTimer.Start();
    }

    private void FadeIn(object sender, EventArgs e)
    {
        if (Opacity < 1 && !isClosing)
        {
            Opacity += 0.05;
        }
        else if (isClosing)
        {
            if (Opacity > 0)
            {
                Opacity -= 0.05;
            }
            else
            {
                fadeTimer.Stop();
                Close();
            }
        }
        else
        {
            fadeTimer.Stop();
        }
    }

    protected override void OnFormClosing(FormClosingEventArgs e)
    {
        if (!isClosing)
        {
            e.Cancel = true;
            isClosing = true;
            fadeTimer.Start();
        }
        base.OnFormClosing(e);
    }

    protected override void OnPaintBackground(PaintEventArgs e)
    {
        base.OnPaintBackground(e);
        LinearGradientBrush lgb = new LinearGradientBrush(ClientRectangle, Color.White, Color.Gray, LinearGradientMode.Vertical);
        e.Graphics.FillRectangle(lgb, ClientRectangle);
    }

    protected override void OnMouseDown(MouseEventArgs e)
    {
        base.OnMouseDown(e);
        if (e.Button == MouseButtons.Left)
        {
            toolStrip.Capture = false;
            Message m = Message.Create(Handle, 0xA1, new IntPtr(2), IntPtr.Zero);
            DefWndProc(ref m);
        }
    }
}
